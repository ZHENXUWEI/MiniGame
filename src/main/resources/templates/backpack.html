<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„èƒŒåŒ…</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .backpack-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.8em;
            margin-bottom: 10px;
            font-weight: 300;
            background: linear-gradient(45deg, #3498db, #2ecc71);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .money-display {
            font-size: 1.8em;
            color: #f39c12;
            font-weight: bold;
            margin: 15px 0;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
            color: #bdc3c7;
        }

        .controls-panel {
            background: #ecf0f1;
            padding: 25px;
            border-bottom: 1px solid #bdc3c7;
        }

        .search-controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        @media (max-width: 768px) {
            .search-controls {
                grid-template-columns: 1fr;
            }
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .item-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
            height: fit-content;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .item-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            position: relative;
        }

        .item-name {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .item-type {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .quantity-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #e74c3c;
            color: white;
            border-radius: 15px;
            padding: 4px 10px;
            font-size: 0.9em;
            font-weight: bold;
            min-width: 30px;
            text-align: center;
        }

        .item-content {
            padding: 20px;
        }

        .item-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .stat-label {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .damage-value {
            color: #e74c3c;
        }

        .price-value {
            color: #27ae60;
        }

        .durability-info {
            background: #ecf0f1;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }

        .durability-text {
            margin-bottom: 8px;
            font-weight: 500;
        }

        .durability-bar {
            height: 8px;
            background: #bdc3c7;
            border-radius: 4px;
            margin: 8px 0;
            overflow: hidden;
        }

        .durability-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .durability-new {
            background: #2ecc71;
        }

        .durability-worn {
            background: #f39c12;
        }

        .durability-broken {
            background: #e74c3c;
        }

        .durability-status {
            font-size: 0.9em;
            font-weight: bold;
        }

        .status-new {
            color: #27ae60;
        }

        .status-worn {
            color: #f39c12;
        }

        .status-broken {
            color: #e74c3c;
        }

        .item-bullet {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-size: 0.9em;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            grid-column: 1 / -1;
        }

        .stats-panel {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .stats-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            text-align: center;
            color: #3498db;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-card {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-weapon {
            color: #3498db;
        }

        .stat-bullet {
            color: #f39c12;
        }

        .stat-value {
            color: #2ecc71;
        }

        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            color: #bdc3c7;
        }
    </style>
</head>
<body>
<div id="app" class="backpack-container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
        <h1>ğŸ’ æˆ‘çš„èƒŒåŒ…</h1>
        <div class="money-display">ğŸ’° å½“å‰é‡‘é’±: Â¥{{ money.toLocaleString() }}</div>
        <p>ç®¡ç†æ‚¨çš„ç‰©å“å’Œè£…å¤‡ï¼Œåˆç†åˆ†é…èµ„æº</p>
        <div class="user-info">
            <span>æ¬¢è¿ï¼Œ{{ nickname }}</span>
            <el-button type="text" @click="handleLogout" style="color: #e74c3c;">
                é€€å‡ºç™»å½•
            </el-button>
        </div>
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="controls-panel">
        <div class="search-controls">
            <el-form-item label="ç±»å‹ç­›é€‰">
                <el-select v-model="searchType" placeholder="é€‰æ‹©ç‰©å“ç±»å‹" clearable @change="loadBackpack">
                    <el-option label="æ‰€æœ‰ç±»å‹" value=""></el-option>
                    <el-option
                            v-for="type in types"
                            :key="type"
                            :label="type"
                            :value="type">
                    </el-option>
                </el-select>
            </el-form-item>

            <el-form-item label="æœç´¢ç‰©å“">
                <el-input
                        v-model="searchKeyword"
                        placeholder="è¾“å…¥ç‰©å“åç§°æœç´¢..."
                        clearable
                        @input="onSearchInput"
                        @clear="loadBackpack">
                </el-input>
            </el-form-item>

            <div style="display: flex; gap: 10px;">
                <el-button
                        type="primary"
                        @click="loadBackpack"
                        :loading="loading">
                    åˆ·æ–°
                </el-button>
                <el-button
                        type="success"
                        @click="goToMarket">
                    å‰å¾€å¸‚åœº
                </el-button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-panel">
            <div class="stats-title">èƒŒåŒ…ç»Ÿè®¡</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{ totalItems }}</div>
                    <div class="stat-label">æ€»ç‰©å“æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-weapon">{{ weaponCount }}</div>
                    <div class="stat-label">æ­¦å™¨æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-bullet">{{ bulletCount }}</div>
                    <div class="stat-label">å­å¼¹æ•°é‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number stat-value">Â¥{{ totalValue.toLocaleString() }}</div>
                    <div class="stat-label">ç‰©å“æ€»ä»·å€¼</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åŠ è½½çŠ¶æ€ -->
    <div v-if="loading" class="loading">
        <p>åŠ è½½èƒŒåŒ…ç‰©å“ä¸­...</p>
    </div>

    <!-- ç‰©å“ç½‘æ ¼ -->
    <div v-else class="items-grid">
        <div
                v-for="item in backpack"
                :key="item.id"
                class="item-card">
            <div class="item-header">
                <div class="item-name">{{ item.item.name }}</div>
                <div class="item-type">{{ item.item.type }}</div>
                <div v-if="item.quantity > 1" class="quantity-badge">
                    x{{ item.quantity }}
                </div>
            </div>

            <div class="item-content">
                <div class="item-stats">
                    <div class="stat-item">
                        <div class="stat-label">ä¼¤å®³</div>
                        <div class="stat-value damage-value">
                            {{ item.item.damage }}
                            <span v-if="item.item.type === 'å­å¼¹'">å€</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">è´­ä¹°ä»·æ ¼</div>
                        <div class="stat-value price-value">Â¥{{ item.purchasePrice }}</div>
                    </div>
                </div>

                <!-- è€ä¹…åº¦ä¿¡æ¯ -->
                <div v-if="item.currentDurability !== null" class="durability-info">
                    <div class="durability-text">
                        {{ item.currentDurability }}/{{ item.maxDurability }}
                        <span class="durability-status" :class="getDurabilityStatusClass(item)">
                                {{ getDurabilityStatus(item) }}
                            </span>
                    </div>
                    <div class="durability-bar">
                        <div class="durability-fill"
                             :class="getDurabilityBarClass(item)"
                             :style="{ width: getDurabilityPercentage(item) + '%' }">
                        </div>
                    </div>
                </div>

                <div v-else-if="item.item.type === 'å­å¼¹'" class="durability-info">
                    <div class="durability-text">
                        <span style="color: #f39c12;">ğŸ’¥ æ¶ˆè€—å“</span>
                    </div>
                    <div style="font-size: 0.9em; color: #7f8c8d; margin-top: 5px;">
                        å¯å †å ç‰©å“
                    </div>
                </div>

                <div v-if="item.item.usedBullet" class="item-bullet">
                    <strong>ä½¿ç”¨å­å¼¹:</strong> {{ item.item.usedBullet }}
                </div>

                <div class="action-buttons">
                    <el-button
                            type="danger"
                            size="small"
                            @click="sellItem(item)"
                            :disabled="selling">
                        {{ selling ? 'å‡ºå”®ä¸­...' : `å‡ºå”® (Â¥${item.sellPrice})` }}
                    </el-button>
                    <el-tag v-if="item.quantity > 1" type="info" size="small">
                        {{ item.quantity }} ä¸ª
                    </el-tag>
                </div>

                <div style="margin-top: 10px; font-size: 0.8em; color: #7f8c8d;">
                    è´­ä¹°æ—¶é—´: {{ formatTime(item.purchaseTime) }}
                </div>
            </div>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div v-if="backpack.length === 0 && !loading" class="empty-state">
            <h3>èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</h3>
            <p v-if="searchType || searchKeyword">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç‰©å“ï¼Œå°è¯•è°ƒæ•´æœç´¢æ¡ä»¶</p>
            <p v-else>å»å¸‚åœºè´­ä¹°ä¸€äº›ç‰©å“æ¥å……å®æ‚¨çš„èƒŒåŒ…å§ï¼</p>
            <el-button
                    type="primary"
                    style="margin-top: 20px;"
                    @click="goToMarket">
                ğŸª å‰å¾€å¸‚åœº
            </el-button>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, onMounted, computed } = Vue;
    const { ElMessage, ElMessageBox } = ElementPlus;

    const app = createApp({
        setup() {
            // å“åº”å¼æ•°æ®
            const money = ref(0);
            const backpack = ref([]);
            const types = ref([]);
            const searchType = ref('');
            const searchKeyword = ref('');
            const loading = ref(false);
            const selling = ref(false);
            const nickname = ref('æ¸¸å®¢');

            // è®¡ç®—å±æ€§
            const totalItems = computed(() => {
                return backpack.value.reduce((total, item) => total + item.quantity, 0);
            });

            const weaponCount = computed(() => {
                return backpack.value
                    .filter(item => item.item.type !== 'å­å¼¹')
                    .reduce((total, item) => total + item.quantity, 0);
            });

            const bulletCount = computed(() => {
                return backpack.value
                    .filter(item => item.item.type === 'å­å¼¹')
                    .reduce((total, item) => total + item.quantity, 0);
            });

            const totalValue = computed(() => {
                return backpack.value.reduce((total, item) => {
                    return total + (item.purchasePrice * item.quantity);
                }, 0);
            });

            // æ–¹æ³•
            const loadBackpack = async () => {
                loading.value = true;
                try {
                    const params = new URLSearchParams();
                    if (searchType.value) params.append('type', searchType.value);
                    if (searchKeyword.value) params.append('keyword', searchKeyword.value);

                    const response = await axios.get(`/backpack/info?${params}`);
                    if (response.data.success) {
                        money.value = response.data.money;
                        backpack.value = response.data.data.map(item => {
                            // è®¡ç®—å‡ºå”®ä»·æ ¼
                            if (item.item.type === 'å­å¼¹') {
                                item.sellPrice = item.item.value; // å­å¼¹æŒ‰åŸä»·å‡ºå”®
                            } else if (item.currentDurability !== null && item.maxDurability !== null) {
                                const ratio = item.currentDurability / item.maxDurability;
                                item.sellPrice = Math.round(item.item.value * ratio);
                            } else {
                                item.sellPrice = item.item.value;
                            }
                            return item;
                        });
                    } else {
                        ElMessage.error(response.data.message);
                    }
                } catch (error) {
                    ElMessage.error('åŠ è½½èƒŒåŒ…å¤±è´¥: ' + error.message);
                } finally {
                    loading.value = false;
                }
            };

            const loadTypes = async () => {
                try {
                    const response = await axios.get('/backpack/types');
                    if (response.data.success) {
                        types.value = response.data.data;
                    } else {
                        ElMessage.error(response.data.message);
                    }
                } catch (error) {
                    ElMessage.error('åŠ è½½ç±»å‹å¤±è´¥: ' + error.message);
                }
            };

            const onSearchInput = () => {
                // é˜²æŠ–æœç´¢
                clearTimeout(window.searchTimeout);
                window.searchTimeout = setTimeout(() => {
                    loadBackpack();
                }, 500);
            };

            const sellItem = async (item) => {
                selling.value = true;
                try {
                    await ElMessageBox.confirm(
                        `ç¡®å®šè¦å‡ºå”® <strong>${item.item.name}</strong> å—ï¼Ÿ<br>å‡ºå”®ä»·æ ¼: <span style="color: #27ae60; font-weight: bold;">Â¥${item.sellPrice}</span>`,
                        'ç¡®è®¤å‡ºå”®',
                        {
                            confirmButtonText: 'ç¡®å®šå‡ºå”®',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning',
                            dangerouslyUseHTMLString: true
                        }
                    );

                    console.log('å¼€å§‹å‡ºå”®ç‰©å“:', item.id, 'ä»·æ ¼:', item.sellPrice);

                    const response = await axios.post(`/backpack/sell/${item.id}`);
                    console.log('å‡ºå”®å“åº”:', response.data);

                    if (response.data.success) {
                        ElMessage.success(`æˆåŠŸå‡ºå”® ${item.item.name}ï¼Œè·å¾— Â¥${item.sellPrice}`);
                        money.value = response.data.money; // æ›´æ–°å‰ç«¯æ˜¾ç¤ºçš„é‡‘é’±
                        await loadBackpack(); // é‡æ–°åŠ è½½èƒŒåŒ…
                    } else {
                        ElMessage.error(response.data.message);
                    }
                } catch (error) {
                    if (error !== 'cancel') {
                        console.error('å‡ºå”®é”™è¯¯:', error);
                        ElMessage.error('å‡ºå”®å¤±è´¥: ' + error.message);
                    }
                } finally {
                    selling.value = false;
                }
            };

            const goToMarket = () => {
                window.location.href = '/market';
            };

            const handleLogout = async () => {
                try {
                    await ElMessageBox.confirm(
                        'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
                        'ç¡®è®¤é€€å‡º',
                        {
                            confirmButtonText: 'ç¡®å®š',
                            cancelButtonText: 'å–æ¶ˆ',
                            type: 'warning'
                        }
                    );

                    const response = await axios.post('/api/logout');
                    if (response.data.success) {
                        ElMessage.success('é€€å‡ºç™»å½•æˆåŠŸ');
                        window.location.href = '/login';
                    }
                } catch (error) {
                    if (error !== 'cancel') {
                        ElMessage.error('é€€å‡ºç™»å½•å¤±è´¥');
                    }
                }
            };

            // è€ä¹…åº¦ç›¸å…³æ–¹æ³•
            const getDurabilityPercentage = (item) => {
                if (item.currentDurability === null || item.maxDurability === null) return 0;
                return (item.currentDurability / item.maxDurability) * 100;
            };

            const getDurabilityStatus = (item) => {
                if (item.currentDurability === null || item.maxDurability === null) return 'æœªçŸ¥';

                const ratio = item.currentDurability / item.maxDurability;
                if (ratio >= 0.85) return 'å´­æ–°å‡ºäº§';
                if (ratio >= 0.60) return 'ç•¥æœ‰ç£¨æŸ';
                if (ratio >= 0.15) return 'ç ´æŸä¸å ª';
                return 'æ— æ³•ä½¿ç”¨';
            };

            const getDurabilityStatusClass = (item) => {
                if (item.currentDurability === null || item.maxDurability === null) return '';

                const ratio = item.currentDurability / item.maxDurability;
                if (ratio >= 0.85) return 'status-new';
                if (ratio >= 0.60) return 'status-worn';
                if (ratio >= 0.15) return 'status-broken';
                return 'status-broken';
            };

            const getDurabilityBarClass = (item) => {
                if (item.currentDurability === null || item.maxDurability === null) return '';

                const ratio = item.currentDurability / item.maxDurability;
                if (ratio >= 0.85) return 'durability-new';
                if (ratio >= 0.60) return 'durability-worn';
                if (ratio >= 0.15) return 'durability-broken';
                return 'durability-broken';
            };

            const formatTime = (timeString) => {
                if (!timeString) return 'æœªçŸ¥';
                const date = new Date(timeString);
                return date.toLocaleString('zh-CN');
            };

            // è·å–ç”¨æˆ·ä¿¡æ¯
            const getUserInfo = async () => {
                try {
                    const response = await axios.get('/api/user/info');
                    if (response.data.success) {
                        nickname.value = response.data.user.nickname;
                    } else {
                        window.location.href = '/login';
                    }
                } catch (error) {
                    window.location.href = '/login';
                }
            };

            // ç”Ÿå‘½å‘¨æœŸ
            onMounted(() => {
                getUserInfo();
                loadBackpack();
                loadTypes();
            });

            return {
                money,
                backpack,
                types,
                searchType,
                searchKeyword,
                loading,
                selling,
                nickname,
                totalItems,
                weaponCount,
                bulletCount,
                totalValue,
                loadBackpack,
                loadTypes,
                onSearchInput,
                sellItem,
                goToMarket,
                handleLogout,
                getDurabilityPercentage,
                getDurabilityStatus,
                getDurabilityStatusClass,
                getDurabilityBarClass,
                formatTime
            };
        }
    });

    app.use(ElementPlus);
    app.mount('#app');
</script>
</body>
</html>